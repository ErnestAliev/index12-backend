# AI Modes Architecture

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–∞–ø–∫–∏ `/ai`

```
ai/
‚îú‚îÄ‚îÄ modes/                     # –†–µ–∂–∏–º—ã —Ä–∞–±–æ—Ç—ã AI (–ª–æ–≥–∏–∫–∞)
‚îÇ   ‚îú‚îÄ‚îÄ quickMode.js          # 1. –ë—ã—Å—Ç—Ä—ã–µ –∫–Ω–æ–ø–∫–∏ (–¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ)
‚îÇ   ‚îú‚îÄ‚îÄ chatMode.js           # 2. –û–±—ã—á–Ω—ã–π —á–∞—Ç (GPT-4o)
‚îÇ   ‚îî‚îÄ‚îÄ deepMode.js           # 3. CFO —Ä–µ–∂–∏–º (GPT-3o)
‚îÇ
‚îú‚îÄ‚îÄ prompts/                   # –°–∏—Å—Ç–µ–º–Ω—ã–µ –ø—Ä–æ–º–ø—Ç—ã –¥–ª—è LLM
‚îÇ   ‚îú‚îÄ‚îÄ chatPrompt.js         # –ü—Ä–æ–º–ø—Ç –¥–ª—è Chat —Ä–µ–∂–∏–º–∞
‚îÇ   ‚îî‚îÄ‚îÄ deepPrompt.js         # –ü—Ä–æ–º–ø—Ç –¥–ª—è Deep —Ä–µ–∂–∏–º–∞
‚îÇ
‚îú‚îÄ‚îÄ aiRoutes.js               # –ì–ª–∞–≤–Ω—ã–π —Ä–æ—É—Ç–µ—Ä (–º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤)
‚îú‚îÄ‚îÄ dataProvider.js           # –°–ª–æ–π –¥–æ—Å—Ç—É–ø–∞ –∫ MongoDB
‚îî‚îÄ‚îÄ quickHandler.js           # ‚ö†Ô∏è DEPRECATED - —É–¥–∞–ª–∏—Ç—å
```

---

## –†–µ–∂–∏–º 1: Quick Mode

**–§–∞–π–ª:** `modes/quickMode.js`  
**–ú–æ–¥–µ–ª—å:** –ù–ï–¢ (–¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã)  
**–¶–µ–ª—å:** –ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –Ω–∞ —á–∞—Å—Ç—ã–µ –∑–∞–ø—Ä–æ—Å—ã

### Supported Queries:
- ‚úÖ –°—á–µ—Ç–∞ / –ë–∞–ª–∞–Ω—Å—ã
- ‚úÖ –î–æ—Ö–æ–¥—ã
- ‚úÖ –†–∞—Å—Ö–æ–¥—ã (—Å —Ç–æ–ø –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏)
- ‚úÖ –ü–µ—Ä–µ–≤–æ–¥—ã
- ‚úÖ –ö–æ–º–ø–∞–Ω–∏–∏ (—Å –±–∞–ª–∞–Ω—Å–∞–º–∏)
- ‚úÖ –ü—Ä–æ–µ–∫—Ç—ã (–æ–±—â–∏–π —Å–ø–∏—Å–æ–∫ –∏–ª–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π)
- ‚úÖ –ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç—ã
- ‚úÖ –§–∏–∑–ª–∏—Ü–∞
- ‚úÖ –ö–∞—Ç–µ–≥–æ—Ä–∏–∏

### Characteristics:
- ‚ö° **–ë—ã—Å—Ç—Ä–æ**: –±–µ–∑ –≤—ã–∑–æ–≤–∞ OpenAI
- üí∞ **–ë–µ—Å–ø–ª–∞—Ç–Ω–æ**: –Ω–µ —Ä–∞—Å—Ö–æ–¥—É–µ—Ç —Ç–æ–∫–µ–Ω—ã
- üìê **–ü—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ**: –≤—Å–µ–≥–¥–∞ –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç
- üéØ **–¢–æ—á–Ω–æ**: –¥–∞–Ω–Ω—ã–µ –∏–∑ snapshot + MongoDB

### –ö–∞–∫ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –æ—Ç–≤–µ—Ç—ã:
–û—Ç–∫—Ä–æ–π `modes/quickMode.js` –∏ –Ω–∞–π–¥–∏ –Ω—É–∂–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é:

```javascript
// –ü—Ä–∏–º–µ—Ä: –∏–∑–º–µ–Ω–∏—Ç—å —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ –¥–ª—è —Å—á–µ—Ç–æ–≤
function handleAccountsQuery({ dbData, formatTenge }) {
  const lines = [];
  lines.push('üí∞ –ú–û–ò –°–ß–ï–¢–ê'); // ‚Üê –¢–≤–æ—è –∫–∞—Å—Ç–æ–º–∏–∑–∞—Ü–∏—è
  // ...
}
```

---

## –†–µ–∂–∏–º 2: Chat Mode

**–§–∞–π–ª:** `modes/chatMode.js`  
**–ú–æ–¥–µ–ª—å:** `gpt-4o` (env: `OPENAI_MODEL`)  
**–¶–µ–ª—å:** –°–≤–æ–±–æ–¥–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã, –¥–∏–∞–ª–æ–≥

### Characteristics:
- ü§ñ **LLM**: –∏—Å–ø–æ–ª—å–∑—É–µ—Ç GPT-4o
- üí¨ **–ö–æ–Ω—Ç–µ–∫—Å—Ç**: —É—á–∏—Ç—ã–≤–∞–µ—Ç –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞
- üîç **–ì–∏–±–∫–æ—Å—Ç—å**: –º–æ–∂–µ—Ç –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –ª—é–±–æ–π –≤–æ–ø—Ä–æ—Å
- üìä **–î–∞–Ω–Ω—ã–µ**: –ø–æ–ª—É—á–∞–µ—Ç –ø–æ–ª–Ω—ã–π data packet

### –ü—Ä–æ–º–ø—Ç:
–§–∞–π–ª: `prompts/chatPrompt.js`

```javascript
module.exports = `
–¢—ã —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç. –û—Ç–≤–µ—á–∞–π –∫—Ä–∞—Ç–∫–æ, –ø–æ –¥–µ–ª—É, –Ω–∞ —Ä—É—Å—Å–∫–æ–º. 
–ù–µ –≤—ã–¥—É–º—ã–≤–∞–π –¥–∞–Ω–Ω—ã–µ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π —Ç–æ–ª—å–∫–æ –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç.
–§–æ—Ä–º–∞—Ç–∏—Ä—É–π —Å—É–º–º—ã –≤ —Ç–µ–Ω–≥–µ —Å –ø—Ä–æ–±–µ–ª–∞–º–∏ –∏ —Å–∏–º–≤–æ–ª–æ–º ‚Ç∏.`;
```

### –ö–∞–∫ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å:
1. **–ò–∑–º–µ–Ω–∏—Ç—å –ø—Ä–æ–º–ø—Ç:** –û—Ç–∫—Ä–æ–π `prompts/chatPrompt.js` –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π —Ç–µ–∫—Å—Ç
2. **–ò–∑–º–µ–Ω–∏—Ç—å –º–æ–¥–µ–ª—å:** –í `.env` —É—Å—Ç–∞–Ω–æ–≤–∏ `OPENAI_MODEL=gpt-4o-mini` (–∏–ª–∏ –¥—Ä—É–≥—É—é)
3. **–ò–∑–º–µ–Ω–∏—Ç—å —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—É:** –í `chatMode.js` –¥–æ–±–∞–≤—å –ø–∞—Ä–∞–º–µ—Ç—Ä `temperature: 0.7`

---

## –†–µ–∂–∏–º 3: Deep Mode (CFO)

**–§–∞–π–ª:** `modes/deepMode.js`  
**–ú–æ–¥–µ–ª—å:** `gpt-3o` (env: `OPENAI_MODEL_DEEP`)  
**–¶–µ–ª—å:** CFO-—É—Ä–æ–≤–µ–Ω—å –∞–Ω–∞–ª–∏–∑–∞, –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏, —Ä–∏—Å–∫–∏

### Supported Intents:
- ‚úÖ **–§–∏–Ω–∞–Ω—Å–æ–≤–∞—è —Å–∏—Ç—É–∞—Ü–∏—è** (`wantsFinance`)
- ‚úÖ **–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏** (`wantsInvest`)
- ‚úÖ **–†–∞—Å—Ö–æ–¥—ã –ø–æ –ø—Ä–æ–µ–∫—Ç–∞–º** (`wantsProjectExpenses`)
- ‚úÖ **–ê–Ω–∞–ª–∏–∑ –ø–æ—Ç–µ—Ä—å** (`wantsLosses`)
- ‚úÖ **–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ** (`wantsTellUnknown`)
- ‚ö†Ô∏è **Fallback**: –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π summary –∏–ª–∏ LLM

### Characteristics:
- üìä **–ú–µ—Ç—Ä–∏–∫–∏**: calcCoreMetrics() ‚Äî –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–∞—Å—á–µ—Ç—ã
- üî¨ **–ê–Ω–∞–ª–∏–∑**: –ø—Ä–∏–±—ã–ª—å, –º–∞—Ä–∂–∞, –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç—å, risks
- üí° **–°–æ–≤–µ—Ç—ã**: –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏, –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è, –¥–µ–π—Å—Ç–≤–∏—è
- üß† **LLM –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ**: —Ç–æ–ª—å–∫–æ –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

### –ü—Ä–æ–º–ø—Ç:
–§–∞–π–ª: `prompts/deepPrompt.js`

```javascript
module.exports = `
–¢—ã –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–æ–Ω–Ω—ã–π/—Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π —Å–æ–≤–µ—Ç–Ω–∏–∫ CFO. 
–î–µ–π—Å—Ç–≤—É–π –ø–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É –¥–∞–Ω–Ω—ã—Ö.
–û—Ç–≤–µ—á–∞–π —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–æ: –ø—Ä–∏–±—ã–ª—å/–º–∞—Ä–∂–∞, —Ä–∏—Å–∫–∏, –¥–µ–π—Å—Ç–≤–∏—è.
–ù–µ –ø—Ä–∏–¥—É–º—ã–≤–∞–π —Ü–∏—Ñ—Ä—ã. –ö—Ä–∞—Ç–∫–æ, –±–µ–∑ –≤–æ–¥—ã.`;
```

### –ö–∞–∫ –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ intents:

1. –û—Ç–∫—Ä–æ–π `modes/deepMode.js`
2. –ù–∞–π–¥–∏ —Å–µ–∫—Ü–∏—é `// Detect user intent`
3. –î–æ–±–∞–≤—å –Ω–æ–≤—ã–π regex:

```javascript
const wantsMyNewFeature = /–º–æ–π.*–∑–∞–ø—Ä–æ—Å|–∫–ª—é—á–µ–≤—ã–µ.*—Å–ª–æ–≤–∞/i.test(qLower);
```

4. –î–æ–±–∞–≤—å handler:

```javascript
if (wantsMyNewFeature) {
  const lines = [];
  lines.push('–¢–≤–æ–π –∫–∞—Å—Ç–æ–º–Ω—ã–π –æ—Ç–≤–µ—Ç');
  // ... –ª–æ–≥–∏–∫–∞
  return { answer: lines.join('\n'), shouldSaveToHistory: true };
}
```

### –ö–∞–∫ –≤–∫–ª—é—á–∏—Ç—å LLM –¥–ª—è fallback:

–û—Ç–∫—Ä–æ–π `modes/deepMode.js`, –Ω–∞–π–¥–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π `// Option 2: Call LLM`, —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π:

```javascript
// –†–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π —ç—Ç–æ—Ç –±–ª–æ–∫:
const dataContext = formatDbDataForAi(dbData);
const messages = [
  { role: 'system', content: deepPrompt },
  { role: 'system', content: dataContext },
  ...history,
  { role: 'user', content: query }
];
const aiResponse = await openAiChat(messages, { modelOverride: modelDeep });
return { answer: aiResponse, shouldSaveToHistory: true };
```

---

## Environment Variables

```bash
# OpenAI Models
OPENAI_API_KEY=sk-...
OPENAI_MODEL=gpt-4o              # Chat —Ä–µ–∂–∏–º
OPENAI_MODEL_DEEP=gpt-3o         # Deep —Ä–µ–∂–∏–º (–º–æ–∂–Ω–æ o1, o3-mini)

# AI Access
AI_ALLOW_ALL=false
AI_ALLOW_EMAILS=user@example.com
AI_DEBUG=0                       # 1 –¥–ª—è debug –ª–æ–≥–æ–≤
```

---

## Workflow: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Ä–µ–∂–∏–º–∞

### –ü—Ä–∏–º–µ—Ä: Analytics Mode (GPT-4o-mini –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤)

1. **–°–æ–∑–¥–∞–π —Ñ–∞–π–ª:**
```bash
touch ai/modes/analyticsMode.js
```

2. **–ù–∞–ø–∏—à–∏ handler:**
```javascript
async function handleAnalyticsQuery({ query, dbData, openAiChat }) {
  // –¢–≤–æ—è –ª–æ–≥–∏–∫–∞
}
module.exports = { handleAnalyticsQuery };
```

3. **–°–æ–∑–¥–∞–π –ø—Ä–æ–º–ø—Ç:**
```bash
touch ai/prompts/analyticsPrompt.js
```

```javascript
module.exports = `–¢—ã –∞–Ω–∞–ª–∏—Ç–∏–∫ –¥–∞–Ω–Ω—ã—Ö. –°–æ–∑–¥–∞–≤–∞–π –≥—Ä–∞—Ñ–∏–∫–∏ –∏ —Ç–∞–±–ª–∏—Ü—ã...`;
```

4. **–ò–Ω—Ç–µ–≥—Ä–∏—Ä—É–π –≤ aiRoutes.js:**
```javascript
const analyticsMode = require('./modes/analyticsMode');

// –í —Ä–æ—É—Ç–µ—Ä–µ:
if (isAnalyticsMode) {
  const response = await analyticsMode.handleAnalyticsQuery({...});
  return res.json({ text: response });
}
```

---

## Migration Guide

### –°—Ç–∞—Ä–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ ‚Üí –ù–æ–≤–∞—è

| –°—Ç–∞—Ä–æ–µ | –ù–æ–≤–æ–µ | –°—Ç–∞—Ç—É—Å |
|--------|-------|--------|
| `quickHandler.js` | `modes/quickMode.js` | ‚úÖ –ú–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω–æ |
| `chatHandler.js` | `modes/chatMode.js` | ‚úÖ –ú–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω–æ |
| `deepHandler.js` | `modes/deepMode.js` | ‚úÖ –ú–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω–æ |
| `chatPrompt.js` | `prompts/chatPrompt.js` | ‚úÖ –ü–µ—Ä–µ–º–µ—â–µ–Ω–æ |
| `deepPrompt.js` | `prompts/deepPrompt.js` | ‚úÖ –ü–µ—Ä–µ–º–µ—â–µ–Ω–æ |
| `aiRoutes.js` (1678 lines) | `aiRoutes.js` (—É–ø—Ä–æ—â–µ–Ω) | ‚è≥ TODO |

### –ß—Ç–æ —É–¥–∞–ª–∏—Ç—å –ø–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏:
- ‚ùå `ai/quickHandler.js`
- ‚ùå `ai/chatHandler.js`
- ‚ùå `ai/deepHandler.js`

---

## –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –Ω–æ–≤–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã

### ‚úÖ –ú–æ–¥—É–ª—å–Ω–æ—Å—Ç—å
- –ö–∞–∂–¥—ã–π —Ä–µ–∂–∏–º –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º —Ñ–∞–π–ª–µ
- –õ–µ–≥–∫–æ –Ω–∞–π—Ç–∏ –∏ –∏–∑–º–µ–Ω–∏—Ç—å –ª–æ–≥–∏–∫—É
- –ü—Ä–æ—Å—Ç–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### ‚úÖ –≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- –ë—ã—Å—Ç—Ä–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–æ–º–ø—Ç–æ–≤
- A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–∑–Ω—ã—Ö –ø–æ–¥—Ö–æ–¥–æ–≤
- –ú–æ–∂–Ω–æ –≤—ã–∫–ª—é—á–∏—Ç—å —Ä–µ–∂–∏–º –±–µ–∑ –ø—Ä–∞–≤–∫–∏ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∫–æ–¥–∞

### ‚úÖ –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å
- –õ–µ–≥–∫–æ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ —Ä–µ–∂–∏–º—ã
- –ú–∏–Ω–∏–º—É–º –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ aiRoutes.js
- –ù–µ–∑–∞–≤–∏—Å–∏–º—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

### ‚úÖ –ß–∏—Ç–∞–µ–º–æ—Å—Ç—å
- –ü–æ–Ω—è—Ç–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–∞–ø–æ–∫
- –ß–µ—Ç–∫–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏
- –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Ä—è–¥–æ–º —Å –∫–æ–¥–æ–º

---

**–í–µ—Ä—Å–∏—è:** 2.0  
**–î–∞—Ç–∞:** 29.01.2026  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å–æ–∑–¥–∞–Ω–∞, –≥–æ—Ç–æ–≤–∞ –∫ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
