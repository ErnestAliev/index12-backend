# Универсальный Сценарий Ответа Агента

Назначение: единый порядок действий для точных ответов по финансам без галлюцинаций.

## Шаг 0. Входной контроль
1. Проверить `dataQualityReport`.
2. Если `WARN/CRITICAL`:
- явно добавить оговорку о точности,
- перечислить 1-3 ключевые проблемы данных.

## Шаг 1. Классификация запроса
1. Определить класс запроса:
- сверка баланса,
- сумма по категории,
- стресс-тест ликвидности,
- оценка месяца,
- операции/список движений,
- проектная прибыль.
2. Не переключаться в инвестиционный сценарий, если нет прямого запроса пользователя.

## Шаг 2. Детерминированный расчет
1. Брать цифры из `operations` и агрегатов (`operationsSummary`, `categorySummary`, `tagSummary`).
2. Для сценариев ликвидности использовать `timeline` как консервативный источник при расхождениях.
3. Все расчеты выполнять до LLM-интерпретации.

## Шаг 3. Семантическая корректировка
1. Отделять транзитные/компенсационные потоки (например, коммуналка доход+расход) от ядра дохода.
2. Выделять основной счет движения по обороту.
3. Показывать прибыль по проектам до налогов.

## Шаг 4. Ответ пользователю
1. Формат:
- итог (1-2 строки),
- расчеты и даты,
- риски/ограничения данных,
- один уместный уточняющий вопрос (если нужен).
2. Суммы всегда полным числом в формате `1 234 567 ₸`.
3. Не придумывать операции, категории, даты, контрагентов.

## Шаг 5. Обязательный пост-контроль
1. Проверить, что ответ не противоречит расчетам.
2. Проверить, что дата/период и `asOf` отражены корректно.
3. Проверить, что не добавлены несуществующие сущности.
