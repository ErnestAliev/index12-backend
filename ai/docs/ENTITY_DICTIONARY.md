# Словарь Сущностей AI

Назначение: единое определение терминов, чтобы детерминированные расчеты и LLM-интерпретация говорили на одном языке.

## 1) Счет (`accounts`)
- Смысл: контейнер денег, через который проходят доходы, расходы и переводы.
- Ключевые поля: `_id`, `name`, `initialBalance`, `balance/currentBalance`, `futureBalance`, `isExcluded/isHidden`, `companyId|individualId`.
- Инвариант: у счета должен быть один тип владельца (`companyId` или `individualId`).
- Роль в аналитике:
  - `open` (`isHidden=false`) используется для официального денежного потока.
  - `hidden` (`isHidden=true`) используется для полной ликвидности, но может исключаться из отдельных отчетов.

## 2) Владелец счета
- Смысл: юридический держатель счета.
- Хранение:
  - `companies` для юрлиц (`ТОО`, `ИП` в бизнес-контексте).
  - `individuals` для физлиц.
- Важно: `contractors` это контрагенты операций, а не владельцы счета.

## 3) Проект (`projects`)
- Смысл: бизнес-объект/направление для разреза прибыли.
- Ключевые поля: `id/_id`, `name`.
- Роль в аналитике: P&L проекта считается из связанных операций (`income - expense`).

## 4) Категория (`categories`)
- Смысл: экономическая природа операции (аренда, коммуналка, ФОТ и т.д.).
- Ключевые поля: `id/_id`, `name`, `type`.
- Роль в аналитике: группировка факт/прогноз, поиск транзитных потоков, оценка маржи.

## 5) Событие (`events`)
- Смысл: сырая запись Mongo, которую создает пользователь в таймлайне/UI.
- Ключевые поля (подмножество): `date`, `type`, `amount/sum`, `accountId`, `fromAccountId`, `toAccountId`, `projectId`, `categoryId`, `contractorId`, `individualId`.
- Статус: первичный источник данных, может содержать легаси-варианты полей.

## 6) Операция (`dbData.operations`)
- Смысл: нормализованная аналитическая запись, построенная из `events`.
- Ключевые поля: `_id`, `ts`, `date`, `dateIso`, `kind`, `isFact`, `amount`, `rawAmount`, ссылки и имена по счету/проекту/категории/контрагенту.
- Типы: `income | expense | transfer`.
- Правило `isFact`: `op.ts <= asOf`.

## 7) Точка Timeline (`request.timeline[]`)
- Смысл: дневной агрегат для стресс-тестов и ликвидности.
- Ключевые поля: `date`, `income`, `expense`, `offsetExpense`, `withdrawal`, `closingBalance`.
- Формула эффективного расхода: `max(0, expense - offsetExpense)`.

## 8) Snapshot (`request.snapshot`)
- Смысл: срез состояния из frontend (в основном счета/компании).
- Использование: балансы и видимость счетов могут браться из snapshot, операции всегда берутся из Mongo `events`.

## 9) Data Packet (`dbData`)
- Смысл: единый контекст для quick/deep/chat режимов.
- Основные блоки: `meta`, `accounts`, `operations`, `operationsSummary`, `categorySummary`, `tagSummary`, `dataQualityReport`.

## Модель взаимодействия
1. Пользователь создает запись в таймлайне -> появляется сырой `event`.
2. DataProvider загружает `events` и справочники, нормализует их в `operations`.
3. Из `operations` строятся агрегаты (`operationsSummary`, category/tag/project summaries).
4. Deep mode сначала дает детерминированные цифры, потом текстовую интерпретацию.
