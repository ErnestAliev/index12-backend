# Контракт Нормализации (`events` -> `operations`)

Назначение: гарантировать детерминированное и проверяемое преобразование данных до любой AI-интерпретации.

## Входные источники
- Сырые операции: Mongo коллекция `events`.
- Справочники: `accounts`, `companies`, `projects`, `categories`, `contractors`, `individuals`.
- Контекстные фильтры: `periodFilter`, `asOf`, `includeHidden`, `workspaceId`, опционально `snapshot`.

## Шаги преобразования
1. Загрузить сырые `events` по пользователю/workspace и периоду.
2. Удалить служебные/исключенные строки по правилам бизнеса:
- пропускать `excludeFromTotals`, кроме строк взаимозачета,
- пропускать split-parent (`isSplitParent`),
- пропускать retail write-off.
3. Нормализовать сумму:
- источник: `amount`, fallback `sum`,
- аналитическая сумма: `amount = abs(raw)`,
- исходный знак хранить в `rawAmount`.
4. Определить тип операции:
- `transfer`, если есть признаки перевода,
- иначе `income` для притока,
- иначе `expense` для оттока.
5. Определить факт/прогноз:
- `isFact = (op.date <= asOf)`, иначе прогноз.
6. Разрешить ссылки и имена:
- счет/категория/проект/компания/контрагент.
7. Построить детерминированные агрегаты:
- сводка операций (fact/forecast по типам),
- category/tag summaries,
- contractor summary.
8. Сформировать `dataQualityReport` (счетчики проверок и уровень риска).

## Обязательные поля нормализованной операции
- `_id`, `ts`, `date`, `dateIso`
- `kind`, `isFact`
- `amount`, `rawAmount`
- обязательные ссылки по типу:
  - для `income/expense`: `accountId`,
  - для `transfer`: минимум один из `fromAccountId` или `toAccountId`.

## Правила валидации
- Не допускается неизвестный `kind` в прод-аналитике.
- Дата должна быть валидной (`ts` конечное число).
- Не допускаются доходы/расходы без `accountId`.
- Не допускаются переводы без обеих сторон движения.
- Ссылки на сущности должны резолвиться в справочники (или попадать в флаг ошибки).
- Расхождение future net между `timeline` и `operations` должно явно показываться в deep-ответах.

## Статус качества выхода
- `OK`: существенных проблем нет.
- `WARN`: есть несоответствия, ответ обязан содержать оговорку о точности.
- `CRITICAL`: существенные проблемы целостности, ответ не должен быть категоричным.
